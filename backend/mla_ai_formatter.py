"""
mla_ai_formatter.py

Модуль для нейросетевого анализа и форматирования библиографической записи по стандарту MLA.
Использует API нейросетевого сервиса (например, DeepSeek) для анализа ошибок и формирования корректного оформления.
"""

import openai

# Подставьте свой API-ключ от DeepSeek (или другого сервиса)
DEEPSEEK_API_KEY = "sk-15abeb7685c742478a7be0f4827c7cef"
MODEL = "deepseek-chat"  # или другой подходящий, например, "deepseek-chat"

def format_mla_ai(reference: str) -> str:
    """
    Анализирует и форматирует библиографическую запись в стиле MLA с использованием нейросетевого сервиса.
    
    Аргументы:
        reference (str): Исходная библиографическая запись.
    
    Возвращает:
        str: Ответ нейросетевого сервиса, содержащий список обнаруженных ошибок и корректное оформление по MLA.
    """
    prompt = f"""
Ты — эксперт по оформлению библиографических ссылок согласно стандарту MLA.
Задача:
Пользователь передаёт тебе текст библиографической ссылки.
Ты должен выполнить следующее:

1. Проанализировать ссылку и указать ВСЕ ошибки оформления по стандарту MLA:
   - Неправильное оформление автора (ожидается формат: Фамилия, имя)
   - Отсутствие или неверное оформление названия статьи (оно должно быть в кавычках)
   - Отсутствие названия журнала или издательства
   - Ошибки в указании года, тома, номера, страниц, DOI/URL

2. Если ошибок нет, напиши "Ошибок нет".

3. Предложить корректный вариант оформления записи по стандарту MLA.
   
Выводи результат строго по шаблону:

ОШИБКИ:
- Ошибка 1 (описание)
- Ошибка 2 (описание)
...
MLA:
Отформатированная запись по стандарту MLA.

Если каких-то данных не хватает, явно укажи, что необходимо дополнить информацию.

Пример:
Ввод:
"Smith, J., Advances in AI, Journal of Modern Science, 2020, vol. 10, no. 2, pp. 123-130"
Вывод:
ОШИБКИ:
- Неправильное оформление автора (ожидается формат "Smith, John")
- Отсутствует DOI или URL
MLA:
Smith, J. "Advances in AI." Journal of Modern Science, 2020, vol. 10, no. 2, pp. 123-130. [Указать DOI/URL].
   
Ссылка пользователя:
"{reference}"
"""

    # Инициализация клиента OpenAI для работы с DeepSeek API
    client = openai.OpenAI(api_key=DEEPSEEK_API_KEY, base_url="https://api.deepseek.com/v1")
    
    try:
        response = client.chat.completions.create(
            model=MODEL,
            messages=[{"role": "user", "content": prompt}],
            temperature=0.1,
            timeout=150
        )
        return response.choices[0].message.content.strip()
    except Exception as e:
        return f"Ошибка при вызове нейросетевого сервиса: {e}"


# Пример тестирования:
if __name__ == "__main__":
    test_reference = "Smith, J., Advances in AI, Journal of Modern Science, 2020, vol. 10, no. 2, pp. 123-130"
    result = format_mla_ai(test_reference)
    print("Исходная запись:")
    print(test_reference)
    print("\nРезультат нейросетевого форматирования:")
    print(result)
