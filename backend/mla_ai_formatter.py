import openai
from dotenv import load_dotenv

# Загрузка переменных окружения
load_dotenv()
DEEPSEEK_API_KEY = os.getenv("DEEPSEEK_API_KEY")

if not DEEPSEEK_API_KEY:
    raise ValueError("DEEPSEEK_API_KEY не найден в переменных окружения.")

MODEL = "deepseek-chat"

def format_mla_ai(reference: str, subformat: str) -> str:
    prompt_templates = {
        "Журнальная статья": """
Ты — эксперт по стандарту MLA. Проверь ссылку и исправь её, предполагая, что это журнальная статья.

**Задача:**
1. Укажи ключевые ошибки оформления по MLA для журнальной статьи (авторы, название, журнал, том/номер, год, страницы, DOI/URL).
2. Если ошибок нет, напиши "Ошибок нет".
3. Предложи корректный вариант:
   Фамилия, Имя и Имя Фамилия. "Название статьи." Название журнала, т. X, № Y, Год, с. Z–Z. DOI/URL

**Формат вывода:**
ОШИБКИ:
- Ошибка 1
- Ошибка 2
...
MLA:
[Корректная запись]

Если данных не хватает, укажи в квадратных скобках, что нужно дополнить (например, [указать DOI]).

**Ссылка:**
"{reference}"
""",
        "Интернет-журнал": """
Ты — эксперт по стандарту MLA. Проверь ссылку и исправь её, предполагая, что это интернет-журнал.

**Задача:**
1. Укажи ключевые ошибки оформления по MLA для интернет-журнала (авторы, название, журнал, том, год, страницы, URL).
2. Если ошибок нет, напиши "Ошибок нет".
3. Предложи корректный вариант:
   Фамилия, Имя. "Название статьи." Название журнала, т. X, Год, с. Z–Z. URL

**Формат вывода:**
ОШИБКИ:
- Ошибка 1
- Ошибка 2
...
MLA:
[Корректная запись]

Если данных не хватает, укажи в квадратных скобках, что нужно дополнить (например, [указать URL]).

**Ссылка:**
"{reference}"
""",
        "Статья в онлайн-СМИ": """
Ты — эксперт по стандарту MLA. Проверь ссылку и исправь её, предполагая, что это статья в онлайн-СМИ.

**Задача:**
1. Укажи ключевые ошибки оформления по MLA для статьи в онлайн-СМИ (авторы, название, сайт, дата, URL).
2. Если ошибок нет, напиши "Ошибок нет".
3. Предложи корректный вариант:
   Фамилия, Имя. "Название статьи." Название сайта, День Месяц Год, URL

**Формат вывода:**
ОШИБКИ:
- Ошибка 1
- Ошибка 2
...
MLA:
[Корректная запись]

Если данных не хватает, укажи в квадратных скобках, что нужно дополнить (например, [указать URL]).

**Ссылка:**
"{reference}"
""",
        "Монография": """
Ты — эксперт по стандарту MLA. Проверь ссылку и исправь её, предполагая, что это монография.

**Задача:**
1. Укажи ключевые ошибки оформления по MLA для монографии (авторы, название, место, издательство, год).
2. Если ошибок нет, напиши "Ошибок нет".
3. Предложи корректный вариант:
   Фамилия, Имя. Название книги. Место, Издательство, Год

**Формат вывода:**
ОШИБКИ:
- Ошибка 1
- Ошибка 2
...
MLA:
[Корректная запись]

Если данных не хватает, укажи в квадратных скобках, что нужно дополнить (например, [указать издательство]).

**Ссылка:**
"{reference}"
"""
    }

    prompt = prompt_templates.get(subformat)
    if not prompt:
        return f"Ошибка: неверный подтип для MLA: {subformat}"

    client = openai.OpenAI(api_key=DEEPSEEK_API_KEY, base_url="https://api.deepseek.com/v1")
    
    try:
        response = client.chat.completions.create(
            model=MODEL,
            messages=[{"role": "user", "content": prompt.format(reference=reference)}],
            temperature=0.1,
            timeout=150
        )
        return response.choices[0].message.content.strip()
    except Exception as e:
        return f"Ошибка при вызове нейросетевого сервиса: {e}"