"""
apa_ai_formatter.py

Модуль для нейросетевого анализа и форматирования библиографической записи по стандарту APA.
Использует API нейросетевого сервиса (например, DeepSeek) для анализа ошибки и формирования корректного оформления.
"""

import openai

# Подставьте свой API-ключ от DeepSeek (или другого сервиса)
DEEPSEEK_API_KEY = "sk-15abeb7685c742478a7be0f4827c7cef"
MODEL = "deepseek-chat"  # или другой подходящий, например, "deepseek-chat"

def format_apa_ai(reference: str) -> str:
    """
    Анализирует и форматирует библиографическую запись в стиле APA с использованием нейросетевого сервиса.
    
    Аргументы:
        reference (str): Исходная библиографическая запись.
    
    Возвращает:
        str: Ответ нейросетевого сервиса, содержащий список обнаруженных ошибок и корректное оформление по APA.
    """
    prompt = f"""
Ты — эксперт по оформлению библиографических ссылок согласно стандарту APA.
Задача:
Пользователь передаёт тебе текст библиографической ссылки.
Ты должен выполнить следующее:

1. Проанализировать ссылку и указать ВСЕ ошибки оформления по стандарту APA:
   - Неправильное оформление автора (должно быть в формате "Фамилия, И. О.")
   - Отсутствие или неверное оформление года (год должен быть в скобках)
   - Неправильное указание названия работы
   - Отсутствие названия журнала или издательства, если применимо
   - Ошибки в указании тома, номера, страниц и DOI/ISSN/ISBN

2. Если ошибок нет, напиши "Ошибок нет".

3. Предложить корректный вариант оформления записи по стандарту APA.
   
Выводи результат строго по шаблону:

ОШИБКИ:
- Ошибка 1 (описание)
- Ошибка 2 (описание)
...
APA:
Отформатированная запись по стандарту APA.

Если каких-то данных не хватает, явно укажи, что необходимо дополнить информацию.

Пример:
Ввод:
"Smith, J., 2020, Advances in AI, Journal of Modern Science, 10, 2, 123-130"
Вывод:
ОШИБКИ:
- Неправильное оформление автора (ожидается формат "Smith, J. A.")
- Отсутствует DOI
APA:
Smith, J. A. (2020). Advances in AI. Journal of Modern Science, 10(2), 123-130. https://doi.org/...
   
Ссылка пользователя:
"{reference}"
"""

    # Инициализация клиента OpenAI для работы с DeepSeek API
    client = openai.OpenAI(api_key=DEEPSEEK_API_KEY, base_url="https://api.deepseek.com/v1")
    
    try:
        response = client.chat.completions.create(
            model=MODEL,
            messages=[{"role": "user", "content": prompt}],
            temperature=0.1,
            timeout=150
        )
        return response.choices[0].message.content.strip()
    except Exception as e:
        return f"Ошибка при вызове нейросетевого сервиса: {e}"


# Пример тестирования:
if __name__ == "__main__":
    test_reference = "Smith, J., 2020, Advances in AI, Journal of Modern Science, 10, 2, 123-130"
    result = format_apa_ai(test_reference)
    print("Исходная запись:")
    print(test_reference)
    print("\nРезультат нейросетевого форматирования:")
    print(result)
