"""
apa_ai_formatter.py

Модуль для нейросетевого анализа и форматирования библиографической записи по стандарту APA.
Использует API нейросетевого сервиса для анализа ошибок и формирования корректного оформления.
Теперь все подсказки унифицированы и содержат детальные инструкции для проверки следующих нюансов:
- Номер записи (например, "3.") не допускается.
- Автор должен быть в формате "Фамилия, И. О." (например, "Смирнов, А. А.").
- Год издания должен быть указан в круглых скобках сразу после автора.
- Название работы оформлено курсивом (если книга) или взято в кавычки (если статья).
- Место издания должно быть указано полностью (например, "Москва" вместо "М.").
- Издательство указывается после места издания через двоеточие.
- Количество страниц оформляется как "(400 pp.)".
- Для книг обязательно указан корректный ISBN.
Если каких-то данных не хватает, обязательно вывести сообщение о необходимости дополнения.
Выведи:
1. Список обнаруженных ошибок с подробным описанием.
2. Корректный вариант оформления записи по APA согласно шаблону:
   Автор, И. О. (ред.). (Год). Название работы. Место издания: Издательство. (Количество страниц). ISBN номер.
   
Пример:
Ввод:
"3. Экономика и управление: Учебник / Под ред. А. А. Смирнова. — М.: Просвещение, 2018. — 400 с. ISBN 9781231234213"
Вывод:
ОШИБКИ:
- Номер записи "3." не допускается.
- Неправильное оформление автора (ожидается "Смирнов, А. А.").
- Год должен быть в круглых скобках после имени автора.
- Место издания указано неверно (необходимо "Москва" вместо "М.").
- Количество страниц должно быть оформлено как "(400 pp.)".
- ISBN должен быть указан корректно.
APA:
Смирнов, А. А. (ред.). (2018). Экономика и управление: Учебник. Москва: Просвещение. (400 pp.). ISBN 9781231234213.
   
Ссылка пользователя:
"{reference}"
"""

import openai

DEEPSEEK_API_KEY = "sk-15abeb7685c742478a7be0f4827c7cef"
MODEL = "deepseek-chat"

def format_apa_ai(reference: str) -> str:
    prompt = f"""
Ты — эксперт по оформлению библиографических ссылок согласно стандарту APA.
Задача:
Пользователь передаёт тебе текст библиографической ссылки, который должен быть оформлен по следующим правилам:
- Номер записи (например, "3.") не должен присутствовать.
- Автор должен быть в формате "Фамилия, И. О." (например, "Смирнов, А. А.").
- Год издания должен быть указан в круглых скобках сразу после автора.
- Название работы должно быть выделено курсивом (если это книга) или взято в кавычки (если статья).
- Место издания должно быть указано полностью (например, "Москва", а не "М.").
- Издательство следует после места издания, разделённое двоеточием.
- Количество страниц оформляется как "(400 pp.)".
- Для книг обязательно должен быть указан ISBN.
Если каких-то данных не хватает, явно укажи, что необходимо дополнить информацию.
После анализа выведи:
1. Список обнаруженных ошибок с подробным описанием.
2. Корректный вариант оформления записи по стандарту APA согласно шаблону:
   Автор, И. О. (ред.). (Год). Название работы. Место издания: Издательство. (Количество страниц). ISBN номер.
   
Пример:
Ввод:
"3. Экономика и управление: Учебник / Под ред. А. А. Смирнова. — М.: Просвещение, 2018. — 400 с. ISBN 9781231234213"
Вывод:
ОШИБКИ:
- Номер записи "3." не допускается.
- Неправильное оформление автора (ожидается "Смирнов, А. А.").
- Год должен быть в круглых скобках после имени автора.
- Место издания указано неверно (необходимо "Москва" вместо "М.").
- Количество страниц должно быть оформлено как "(400 pp.)".
- ISBN должен быть указан корректно.
APA:
Смирнов, А. А. (ред.). (2018). Экономика и управление: Учебник. Москва: Просвещение. (400 pp.). ISBN 9781231234213.
   
Ссылка пользователя:
"{reference}"
"""
    client = openai.OpenAI(api_key=DEEPSEEK_API_KEY, base_url="https://api.deepseek.com/v1")
    try:
        response = client.chat.completions.create(
            model=MODEL,
            messages=[{"role": "user", "content": prompt}],
            temperature=0.1,
            timeout=150
        )
        return response.choices[0].message.content.strip()
    except Exception as e:
        return f"Ошибка при вызове нейросетевого сервиса: {e}"

# Пример тестирования:
if __name__ == "__main__":
    test_reference = "3. Экономика и управление: Учебник / Под ред. А. А. Смирнова. — М.: Просвещение, 2018. — 400 с. ISBN 9781231234213"
    result = format_apa_ai(test_reference)
    print("Исходная запись:")
    print(test_reference)
    print("\nРезультат нейросетевого форматирования:")
    print(result)
