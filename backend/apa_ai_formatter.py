import openai
from dotenv import load_dotenv

# Загрузка переменных окружения
load_dotenv()
DEEPSEEK_API_KEY = os.getenv("DEEPSEEK_API_KEY")

if not DEEPSEEK_API_KEY:
    raise ValueError("DEEPSEEK_API_KEY не найден в переменных окружения.")

MODEL = "deepseek-chat"

def format_apa_ai(reference: str, subformat: str) -> str:
    prompt_templates = {
        "Журнальная статья": """
Ты — эксперт по стандарту APA (7-е издание). Проверь ссылку и исправь её, предполагая, что это журнальная статья.

**Задача:**
1. Укажи ключевые ошибки оформления по APA для журнальной статьи (авторы, год, название, журнал, том/номер, страницы, DOI).
2. Если ошибок нет, напиши "Ошибок нет".
3. Предложи корректный вариант:
   Фамилия, И. О., & Фамилия, И. О. (Год). Название статьи. Название журнала, том(номер), страницы. DOI

**Формат вывода:**
ОШИБКИ:
- Ошибка 1
- Ошибка 2
...
APA:
[Корректная запись]

Если данных не хватает, укажи в квадратных скобках, что нужно дополнить (например, [указать DOI]).

**Ссылка:**
"{reference}"
""",
        "Онлайн-журнал": """
Ты — эксперт по стандарту APA (7-е издание). Проверь ссылку и исправь её, предполагая, что это онлайн-журнал.

**Задача:**
1. Укажи ключевые ошибки оформления по APA для онлайн-журнала (авторы, год, название, журнал, номер, страницы, URL).
2. Если ошибок нет, напиши "Ошибок нет".
3. Предложи корректный вариант:
   Фамилия, И. О., & Фамилия, И. О. (Год). Название статьи. Название журнала, (номер), страницы. Retrieved from URL

**Формат вывода:**
ОШИБКИ:
- Ошибка 1
- Ошибка 2
...
APA:
[Корректная запись]

Если данных не хватает, укажи в квадратных скобках, что нужно дополнить (например, [указать URL]).

**Ссылка:**
"{reference}"
""",
        "Сетевое издание": """
Ты — эксперт по стандарту APA (7-е издание). Проверь ссылку и исправь её, предполагая, что это сетевое издание.

**Задача:**
1. Укажи ключевые ошибки оформления по APA для сетевого издания (авторы, год, дата, название, сайт, URL).
2. Если ошибок нет, напиши "Ошибок нет".
3. Предложи корректный вариант:
   Фамилия, И. О. (Год, Month Day). Название статьи. Название сайта. Retrieved from URL

**Формат вывода:**
ОШИБКИ:
- Ошибка 1
- Ошибка 2
...
APA:
[Корректная запись]

Если данных не хватает, укажи в квадратных скобках, что нужно дополнить (например, [указать URL]).

**Ссылка:**
"{reference}"
""",
        "Книга": """
Ты — эксперт по стандарту APA (7-е издание). Проверь ссылку и исправь её, предполагая, что это книга.

**Задача:**
1. Укажи ключевые ошибки оформления по APA для книги (авторы, год, название, город, издательство).
2. Если ошибок нет, напиши "Ошибок нет".
3. Предложи корректный вариант:
   Фамилия, И. О., & Фамилия, И. О. (Год). Название книги. Город: Издательство

**Формат вывода:**
ОШИБКИ:
- Ошибка 1
- Ошибка 2
...
APA:
[Корректная запись]

Если данных не хватает, укажи в квадратных скобках, что нужно дополнить (например, [указать издательство]).

**Ссылка:**
"{reference}"
"""
    }

    prompt = prompt_templates.get(subformat)
    if not prompt:
        return f"Ошибка: неверный подтип для APA: {subformat}"

    client = openai.OpenAI(api_key=DEEPSEEK_API_KEY, base_url="https://api.deepseek.com/v1")
    
    try:
        response = client.chat.completions.create(
            model=MODEL,
            messages=[{"role": "user", "content": prompt.format(reference=reference)}],
            temperature=0.1,
            timeout=150
        )
        return response.choices[0].message.content.strip()
    except Exception as e:
        return f"Ошибка при вызове нейросетевого сервиса: {e}"