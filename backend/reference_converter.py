# backend/reference_converter.py

import openai
import logging
from dotenv import load_dotenv

# Загрузка переменных окружения
load_dotenv()
DEEPSEEK_API_KEY = os.getenv("DEEPSEEK_API_KEY")

if not DEEPSEEK_API_KEY:
    raise ValueError("DEEPSEEK_API_KEY не найден в переменных окружения.")

MODEL = "deepseek-chat"


# Настройка логирования
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

def convert_to_format(reference: str, target_format: str, target_subformat: str) -> str:
    """
    Конвертирует библиографическую запись в указанный формат и подтип.
    Возвращает только отформатированную ссылку без объяснений.
    """
    prompt_templates = {
        "APA": {
            "Журнальная статья": """Ты — эксперт по оформлению ссылок по APA. Преобразуй библиографическую запись в формат "Журнальная статья" согласно APA:
Фамилия, И. О., & Фамилия, И. О. (Год). Название статьи. Название журнала, том(номер), страницы. DOI
Верни ТОЛЬКО отформатированную ссылку, без объяснений, комментариев или предупреждений. Если данных недостаточно (например, нет страниц или DOI), используй доступные поля и не добавляй выдуманные значения. Исключи любые примечания (например, "в печати").
Запись: "{reference}".""",
            "Онлайн-журнал": """Ты — эксперт по оформлению ссылок по APA. Преобразуй библиографическую запись в формат "Онлайн-журнал" согласно APA:
Фамилия, И. О., & Фамилия, И. О. (Год). Название статьи. Название журнала, (номер), страницы. Retrieved from URL
Верни ТОЛЬКО отформатированную ссылку, без объяснений, комментариев или предупреждений. Если данных недостаточно, используй доступные поля и не добавляй выдуманные значения. Исключи любые примечания (например, "в печати").
Запись: "{reference}".""",
            "Сетевое издание": """Ты — эксперт по оформлению ссылок по APA. Преобразуй библиографическую запись в формат "Сетевое издание" согласно APA:
Фамилия, И. О. (Год, Month Day). Название статьи. Название сайта. Retrieved from URL
Верни ТОЛЬКО отформатированную ссылку, без объяснений, комментариев или предупреждений. Если данных недостаточно, используй доступные поля и не добавляй выдуманные значения.
Запись: "{reference}".""",
            "Книга": """Ты — эксперт по оформлению ссылок по APA. Преобразуй библиографическую запись в формат "Книга" согласно APA:
Фамилия, И. О., & Фамилия, И. О. (Год). Название книги. Город: Издательство
Верни ТОЛЬКО отформатированную ссылку, без объяснений, комментариев или предупреждений. Если данных недостаточно, используй доступные поля и не добавляй выдуманные значения.
Запись: "{reference}"."""
        },
        "GOST": {
            "Статья в журнале": """Ты — эксперт по ГОСТ Р 7.0.100-2018. Преобразуй библиографическую запись в формат "Статья в журнале":
Фамилия И.О. Название статьи // Журнал. Год. Т. X. № Y. С. Z–Z. DOI/URL
Верни ТОЛЬКО отформатированную ссылку, без объяснений, комментариев или предупреждений. Если данных недостаточно, используй доступные поля и не добавляй выдуманные значения.
Запись: "{reference}".""",
            "Книга": """Ты — эксперт по ГОСТ Р 7.0.100-2018. Преобразуй библиографическую запись в формат "Книга":
Фамилия И.О. Название. Место: Издательство, Год. Кол-во страниц
Верни ТОЛЬКО отформатированную ссылку, без объяснений, комментариев или предупреждений. Если данных недостаточно, используй доступные поля и не добавляй выдуманные значения.
Запись: "{reference}".""",
            "Материалы конференций": """Ты — эксперт по ГОСТ Р 7.0.100-2018. Преобразуй библиографическую запись в формат "Материалы конференций":
Название / под ред. Фамилия И.О. Место: Издательство, Год. Кол-во страниц
Верни ТОЛЬКО отформатированную ссылку, без объяснений, комментариев или предупреждений. Если данных недостаточно, используй доступные поля и не добавляй выдуманные значения.
Запись: "{reference}".""",
            "Статья в печати": """Ты — эксперт по ГОСТ Р 7.0.100-2018. Преобразуй библиографическую запись в формат "Статья в печати":
Фамилия И.О. Название // Журнал. Год. Т. X. № Y (в печати)
Верни ТОЛЬКО отформатированную ссылку, без объяснений, комментариев или предупреждений. Если данных недостаточно, используй доступные поля и не добавляй выдуманные значения.
Запись: "{reference}".""",
            "Онлайн-статья": """Ты — эксперт по ГОСТ Р 7.0.100-2018. Преобразуй библиографическую запись в формат "Онлайн-статья":
Фамилия И.О. Название // Журнал. Год. URL: ... (дата обращения: ДД.ММ.ГГГГ)
Верни ТОЛЬКО отформатированную ссылку, без объяснений, комментариев или предупреждений. Если данных недостаточно, используй доступные поля и не добавляй выдуманные значения.
Запись: "{reference}"."""
        },
        "MLA": {
            "Журнальная статья": """Ты — эксперт по MLA. Преобразуй библиографическую запись в формат "Журнальная статья":
Фамилия, Имя и Имя Фамилия. "Название статьи." Название журнала, т. X, № Y, Год, с. Z–Z. DOI/URL
Верни ТОЛЬКО отформатированную ссылку, без объяснений, комментариев или предупреждений. Если данных недостаточно (например, нет страниц), используй "n. pag." для страниц. Исключи любые примечания (например, "в печати"). Если данных для DOI/URL нет, пропусти это поле. Используй доступные поля и не добавляй выдуманные значения.
Запись: "{reference}".""",
            "Интернет-журнал": """Ты — эксперт по MLA. Преобразуй библиографическую запись в формат "Интернет-журнал":
Фамилия, Имя, Имя Фамилия и Имя Фамилия. "Название статьи." Название журнала, т. X, Год, с. Z–Z. URL
Верни ТОЛЬКО отформатированную ссылку, без объяснений, комментариев или предупреждений. Если данных недостаточно (например, нет страниц), используй "n. pag." для страниц. Исключи любые примечания (например, "в печати"). Используй доступные поля и не добавляй выдуманные значения.
Запись: "{reference}".""",
            "Статья в онлайн-СМИ": """Ты — эксперт по MLA. Преобразуй библиографическую запись в формат "Статья в онлайн-СМИ":
Фамилия, Имя. "Название статьи." Название сайта, День Месяц Год, URL
Верни ТОЛЬКО отформатированную ссылку, без объяснений, комментариев или предупреждений. Если данных недостаточно, используй доступные поля и не добавляй выдуманные значения.
Запись: "{reference}".""",
            "Монография": """Ты — эксперт по MLA. Преобразуй библиографическую запись в формат "Монография":
Фамилия, Имя и Имя Фамилия. Название книги. Место, Издательство, Год
Верни ТОЛЬКО отформатированную ссылку, без объяснений, комментариев или предупреждений. Если данных недостаточно, используй доступные поля и не добавляй выдуманные значения.
Запись: "{reference}"."""
        }
    }

    format_dict = prompt_templates.get(target_format.upper())
    if not format_dict:
        logger.error("Неверный формат: %s", target_format)
        return "Ошибка: неверный формат (допустимые: APA, GOST, MLA)."

    prompt = format_dict.get(target_subformat)
    if not prompt:
        logger.error("Неверный подтип для %s: %s", target_format, target_subformat)
        return f"Ошибка: неверный подтип для {target_format}."

    client = openai.OpenAI(api_key=DEEPSEEK_API_KEY, base_url="https://api.deepseek.com/v1")
    try:
        response = client.chat.completions.create(
            model=MODEL,
            messages=[{"role": "user", "content": prompt.format(reference=reference)}],
            temperature=0.1,
            timeout=150
        )
        converted = response.choices[0].message.content.strip()
        logger.info("Конвертированная ссылка: %s", converted)
        return converted
    except Exception as e:
        logger.error("Ошибка AI-сервиса: %s", str(e))
        return f"Ошибка AI-сервиса: {str(e)}"