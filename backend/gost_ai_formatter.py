"""
gost_ai_formatter.py

Модуль для нейросетевого анализа и форматирования библиографической записи по стандарту ГОСТ Р 7.0.100-2018.
Подсказки теперь унифицированы и содержат следующие требования:
- Номер записи в начале не должен присутствовать.
- Автор должен быть в формате "Фамилия И.О." (без запятых).
- Название статьи или работы должно быть указано корректно.
- Название журнала или издательства должно быть приведено полностью.
- Год издания указывается после названия с тире.
- При наличии тома, номера и страниц оформление должно соответствовать шаблону: "– Т. X. – № Y. – С. Z–Z."
- Обязательно указан ISSN (для журналов) или ISBN (для книг).
- Если источник зарубежный и запрещён (например, IEEE, Springer с 2024 года), это должно быть явно отмечено.
Если каких-то данных не хватает, укажи, что необходимо дополнить информацию.
Выведи:
1. Список обнаруженных ошибок с подробным описанием.
2. Корректный вариант оформления записи по ГОСТ согласно шаблону:
   Автор И.О. Название статьи // Название журнала. – Год. – Т. X. – № Y. – С. Z–Z. – ISSN/ISBN XXXX-XXXX.
   
Пример:
Ввод:
"Петров 2020, стр. 15"
Вывод:
ОШИБКИ:
- Неполное имя автора (ожидается формат "Петров И.О.").
- Отсутствует название статьи.
- Отсутствует название журнала.
- Отсутствуют том и номер выпуска.
ГОСТ:
Петров И.О. Название статьи // Название журнала. – 2020. – Т. X. – № Y. – С. 15. – ISSN XXXX-XXXX.
   
Ссылка пользователя:
"{text}"
"""

import openai

DEEPSEEK_API_KEY = "sk-15abeb7685c742478a7be0f4827c7cef"
MODEL = "deepseek-chat"

def format_gost(text: str) -> str:
    prompt = f"""
Ты — эксперт по оформлению библиографических ссылок согласно стандарту ГОСТ Р 7.0.100-2018.
Задача:
Пользователь передаёт тебе текст библиографической ссылки, который должен соответствовать следующим требованиям:
- Номер записи в начале не допускается.
- Автор должен быть в формате "Фамилия И.О." (например, "Петров И.О.").
- Название статьи или работы должно быть указано корректно.
- Название журнала или издательства должно быть приведено полностью.
- Год издания указывается с тире после названия.
- При наличии тома, номера и страниц оформление должно быть: "– Т. X. – № Y. – С. Z–Z."
- Обязательно должен быть указан ISSN (для журналов) или ISBN (для книг).
- Если источник зарубежный и запрещён (например, IEEE, Springer с 2024 года), это должно быть явно указано.
Если каких-то данных не хватает, явно укажи, что необходимо дополнить информацию.
После анализа выведи:
1. Список обнаруженных ошибок с подробным описанием.
2. Корректный вариант оформления записи по ГОСТ согласно шаблону:
   Автор И.О. Название статьи // Название журнала. – Год. – Т. X. – № Y. – С. Z–Z. – ISSN/ISBN XXXX-XXXX.
   
Пример:
Ввод:
"Петров 2020, стр. 15"
Вывод:
ОШИБКИ:
- Неполное имя автора (ожидается формат "Петров И.О.").
- Отсутствует название статьи.
- Отсутствует название журнала.
- Отсутствуют том и номер выпуска.
ГОСТ:
Петров И.О. Название статьи // Название журнала. – 2020. – Т. X. – № Y. – С. 15. – ISSN XXXX-XXXX.
   
Ссылка пользователя:
"{text}"
"""
    client = openai.OpenAI(api_key=DEEPSEEK_API_KEY, base_url="https://api.deepseek.com/v1")
    try:
        response = client.chat.completions.create(
            model="deepseek-reasoner",
            messages=[{"role": "user", "content": prompt}],
            temperature=0.1,
            timeout=150
        )
        return response.choices[0].message.content.strip()
    except Exception as e:
        return f"Ошибка при вызове нейросетевого сервиса: {e}"

# Пример тестирования:
if __name__ == "__main__":
    test_cases = [
        "Петров 2020, стр. 15",
        "Смирнов 2023, статья про нейросети, журнал 'AI Today', стр. 45-48",
        "Петров И.С. Современные проблемы математики // Успехи математических наук. – 2022. – Т. 77. – №3. – С. 123–156.",
        "Неизвестный автор. Наука в XXI веке. URL: https://science21.com, дата обращения: 10.03.2025",
    ]
    for text in test_cases:
        result = format_gost(text)
        print(f"Исходный текст: {text}\nРезультат:\n{result}\n{'-'*60}")
