import openai
from dotenv import load_dotenv

# Загрузка переменных окружения
load_dotenv()
DEEPSEEK_API_KEY = os.getenv("DEEPSEEK_API_KEY")

if not DEEPSEEK_API_KEY:
    raise ValueError("DEEPSEEK_API_KEY не найден в переменных окружения.")

MODEL = "deepseek-chat"

def format_gost(text: str, subformat: str) -> str:
    prompt_templates = {
        "Статья в журнале": """
Ты — эксперт по ГОСТ Р 7.0.100-2018. Проверь ссылку и исправь её, предполагая, что это статья в журнале.

**Задача:**
1. Укажи ключевые ошибки оформления по ГОСТ для статьи в журнале (авторы, название, журнал, год, том/номер, страницы, DOI/URL).
2. Если ошибок нет, напиши "Ошибок нет".
3. Предложи корректный вариант:
   Фамилия И.О. Название статьи // Журнал. Год. Т. X. № Y. С. Z–Z. DOI/URL

**Формат вывода:**
ОШИБКИ:
- Ошибка 1
- Ошибка 2
...
ГОСТ:
[Корректная запись]

Если данных не хватает, укажи в квадратных скобках, что нужно дополнить (например, [Название журнала]).

**Ссылка:**
"{text}"
""",
        "Книга": """
Ты — эксперт по ГОСТ Р 7.0.100-2018. Проверь ссылку и исправь её, предполагая, что это книга.

**Задача:**
1. Укажи ключевые ошибки оформления по ГОСТ для книги (авторы, название, место, издательство, год, страницы).
2. Если ошибок нет, напиши "Ошибок нет".
3. Предложи корректный вариант:
   Фамилия И.О. Название. Место: Издательство, Год. Кол-во страниц

**Формат вывода:**
ОШИБКИ:
- Ошибка 1
- Ошибка 2
...
ГОСТ:
[Корректная запись]

Если данных не хватает, укажи в квадратных скобках, что нужно дополнить (например, [Издательство]).

**Ссылка:**
"{text}"
""",
        "Материалы конференций": """
Ты — эксперт по ГОСТ Р 7.0.100-2018. Проверь ссылку и исправь её, предполагая, что это материалы конференций.

**Задача:**
1. Укажи ключевые ошибки оформления по ГОСТ для материалов конференций (название, редакторы, место, издательство, год, страницы).
2. Если ошибок нет, напиши "Ошибок нет".
3. Предложи корректный вариант:
   Название / под ред. Фамилия И.О. Место: Издательство, Год. Кол-во страниц

**Формат вывода:**
ОШИБКИ:
- Ошибка 1
- Ошибка 2
...
ГОСТ:
[Корректная запись]

Если данных не хватает, укажи в квадратных скобках, что нужно дополнить (например, [Издательство]).

**Ссылка:**
"{text}"
""",
        "Статья в печати": """
Ты — эксперт по ГОСТ Р 7.0.100-2018. Проверь ссылку и исправь её, предполагая, что это статья в печати.

**Задача:**
1. Укажи ключевые ошибки оформления по ГОСТ для статьи в печати (авторы, название, журнал, год, том/номер).
2. Если ошибок нет, напиши "Ошибок нет".
3. Предложи корректный вариант:
   Фамилия И.О. Название // Журнал. Год. Т. X. № Y (в печати)

**Формат вывода:**
ОШИБКИ:
- Ошибка 1
- Ошибка 2
...
ГОСТ:
[Корректная запись]

Если данных не хватает, укажи в квадратных скобках, что нужно дополнить (например, [Название журнала]).

**Ссылка:**
"{text}"
""",
        "Онлайн-статья": """
Ты — эксперт по ГОСТ Р 7.0.100-2018. Проверь ссылку и исправь её, предполагая, что это онлайн-статья.

**Задача:**
1. Укажи ключевые ошибки оформления по ГОСТ для онлайн-статьи (авторы, название, журнал, год, URL, дата обращения).
2. Если ошибок нет, напиши "Ошибок нет".
3. Предложи корректный вариант:
   Фамилия И.О. Название // Журнал. Год. URL: ... (дата обращения: ДД.ММ.ГГГГ)

**Формат вывода:**
ОШИБКИ:
- Ошибка 1
- Ошибка 2
...
ГОСТ:
[Корректная запись]

Если данных не хватает, укажи в квадратных скобках, что нужно дополнить (например, [указать URL]).

**Ссылка:**
"{text}"
"""
    }

    prompt = prompt_templates.get(subformat)
    if not prompt:
        return f"Ошибка: неверный подтип для ГОСТ: {subformat}"

    client = openai.OpenAI(api_key=DEEPSEEK_API_KEY, base_url="https://api.deepseek.com/v1")
    try:
        response = client.chat.completions.create(
            model=MODEL,
            messages=[{"role": "user", "content": prompt.format(text=text)}],
            temperature=0.1,
            timeout=150
        )
        return response.choices[0].message.content.strip()
    except Exception as e:
        return f"Ошибка при вызове нейросетевого сервиса: {e}"